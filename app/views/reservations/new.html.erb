<h2>New Reservation</h2>

<%= render "shared/error_messages", object: @reservation %>

<% if @selected_timeslot %>
  <% available_tables = available_tables_count(@selected_timeslot) %>
  <div class="alert alert-info d-flex justify-content-between align-items-center">
    <span>
      Selected timeslot:
      <strong><%= @selected_timeslot.date.strftime('%A, %B %-d, %Y') %></strong>
      at
      <strong><%= @selected_timeslot.start_time.strftime('%I:%M %p') %> – <%= @selected_timeslot.end_time ? @selected_timeslot.end_time.strftime('%I:%M %p') : 'Open-ended' %></strong>
    </span>
    <span class="badge <%= available_tables.positive? ? 'bg-success' : 'bg-secondary' %>">
      <%= pluralize(available_tables, 'table') %> available
    </span>
  </div>
<% end %>

<%= form_with model: @reservation, local: true do |f| %>

  <strong>Table:</strong><br>
  <%= f.collection_select :table_id, @tables, :id, ->(t) { "Table ##{t.id} — Tables: #{t.quantity}, Capacity: #{t.capacity}" }, { prompt: "Select a Table", selected: params[:table_id] }, { id: 'reservation_table_id' } %>
  </p>
  <p>
    <strong>Timeslot:</strong><br>
    <% prompt_text = @selected_timeslot ? "Change the selected timeslot" : "Select a Timeslot" %>
  <%= f.collection_select :timeslot_id, @timeslots, :id, ->(t) { "#{t.date} - #{t.start_time.strftime('%I:%M %p')}#{t.end_time ? " – #{t.end_time.strftime('%I:%M %p')}" : ' – Open-ended'}" }, { prompt: prompt_text, selected: @selected_timeslot&.id }, { id: 'reservation_timeslot_id' } %>
  </p>

  <p>
    <strong>Number of People:</strong><br>
    <%= f.number_field :num_people, min: 1 %>
  </p>

  <p><%= f.submit "Create Reservation" %></p>
<% end %>

<%= link_to "Back", reservations_path %>

<hr>
<section class="mt-4">
  <h3>Availability</h3>

  <% if @timeslots_by_date.blank? %>
    <p class="text-muted">No upcoming timeslots are currently available. Please check back later.</p>
  <% else %>
    <% @timeslots_by_date.sort.each do |date, slots| %>
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <strong><%= date.strftime('%A, %B %-d, %Y') %></strong>
          <span class="badge bg-secondary"><%= pluralize(slots.size, 'slot') %></span>
        </div>
        <div class="row g-3">
          <% slots.each do |slot| %>
            <% available_tables = available_tables_count(slot) %>
            <div class="col-12 col-md-6 col-lg-4">
              <div class="card mb-0 <%= 'border-primary' if @selected_timeslot&.id == slot.id %>">
                <div class="card-body d-flex justify-content-between align-items-center">
                  <div>
                    <div class="fw-bold"><%= slot.start_time&.strftime('%I:%M %p') %> &ndash; <%= slot.end_time ? slot.end_time.strftime('%I:%M %p') : 'Open-ended' %></div>
                    <%# optional small availability info */ %>
                    <% if available_tables_for(slot).any? %>
                      <div class="text-muted small">Available: <%= pluralize(available_tables_for(slot).count, 'table') %></div>
                    <% else %>
                      <div class="text-muted small">No tables available</div>
                    <% end %>
                  </div>

                  <div class="text-end">
                    <% if available_tables_for(slot).any? %>
                      <%= link_to 'Select slot', new_reservation_path(timeslot_id: slot.id), class: 'btn btn-sm btn-outline-primary' %>
                    <% else %>
                      <span class="text-muted">Fully booked</span>
                    <% end %>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  <% end %>
</section>
