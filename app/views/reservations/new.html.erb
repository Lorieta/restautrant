<div class="center-page">
  <div class="container">
    <div class="row">
      <div class="col-md-8 mx-auto">
        <div class="card">
            <div class="card-body" data-controller="timeslot-selector<%= ' user-selector' if defined?(current_user) && current_user.respond_to?(:admin?) && current_user.admin? %>">
            <h2 class="card-title">New Reservation</h2>

            <%= render "shared/error_messages", object: @reservation %>

            <%# Contact details: will update when a different user is selected (via Stimulus) %>
              <% if defined?(current_user) && current_user.respond_to?(:admin?) && current_user.admin? %>
              <section class="mb-3 contact-info" data-user-selector-target="wrapper" data-users='<%= raw((@users || [current_user]).map { |u| { id: u.id, name: u.name, phone: u.phone, email: u.email } }.to_json) %>'>
            <% else %>
              <section class="mb-3 contact-info">
            <% end %>
              <h5 class="mb-2">Contact details</h5>
              <dl class="row reservation-summary">
                <dt class="col-sm-3 text-muted">Name</dt>
                <dd class="col-sm-9" data-user-selector-target="name"><span class="fw-bold"><%= current_user.name %></span></dd>

                <dt class="col-sm-3 text-muted">Phone</dt>
                <dd class="col-sm-9" data-user-selector-target="phone"><span class="text-muted"><%= current_user.phone.presence || 'N/A' %></span></dd>

                <dt class="col-sm-3 text-muted">Email</dt>
                <dd class="col-sm-9" data-user-selector-target="email"><span class="text-muted"><%= current_user.email %></span></dd>
              </dl>
            </section>

            <% if @selected_timeslot %>
              <% available_tables = available_tables_count(@selected_timeslot) %>
              <div class="alert alert-info d-flex justify-content-between align-items-center">
                <span>
                  Selected timeslot:
                  <strong><%= @selected_timeslot.date.strftime('%A, %B %-d, %Y') %></strong>
                  at
                  <strong><%= @selected_timeslot.start_time.strftime('%I:%M %p') %> – <%= @selected_timeslot.end_time ? @selected_timeslot.end_time.strftime('%I:%M %p') : 'Open-ended' %></strong>
                </span>
                <span class="badge <%= available_tables.positive? ? 'bg-success' : 'bg-secondary' %>">
                  <%= pluralize(available_tables, 'table') %> available
                </span>
              </div>
            <% end %>


            <%= form_with model: @reservation, local: true do |f| %>

              <%# User selector (admins only). Selecting a user will update the contact details above. %>
              <% if defined?(current_user) && current_user.respond_to?(:admin?) && current_user.admin? %>
                <p>
                  <strong>For user:</strong><br>
                  <%= f.collection_select :user_id, @users || User.none, :id, :name, { prompt: "Select a user", selected: (@reservation.user_id || current_user.id) }, { data: { action: "change->user-selector#onUserChange", "user-selector-target": "select" } } %>
                </p>
              <% else %>
                <%# Ensure user_id is still submitted (non-admins) but hidden and fixed to current_user %>
                <%= f.hidden_field :user_id, value: current_user.id %>
              <% end %>

              <p>
                <strong>Table:</strong><br>
                <%= f.collection_select :table_id, @tables, :id, ->(t) { "Table ##{t.id} — Tables: #{t.quantity}, Capacity: #{t.capacity}" }, { prompt: "Select a Table", selected: params[:table_id] }, { id: 'reservation_table_id', data: { "timeslot-selector-target": "tableSelect" } } %>
              </p>
              <p>
                <strong>Timeslot:</strong><br>
                <% prompt_text = @selected_timeslot ? "Change the selected timeslot" : "Select a Timeslot" %>
                <%= f.collection_select :timeslot_id, @timeslots, :id, ->(t) { "#{t.date} - #{t.start_time.strftime('%I:%M %p')}#{t.end_time ? " – #{t.end_time.strftime('%I:%M %p')}" : ' – Open-ended'}" }, { prompt: prompt_text, selected: @selected_timeslot&.id }, { id: 'reservation_timeslot_id', data: { "timeslot-selector-target": "timeslotSelect" } } %>
              </p>

              <p>
                <strong>Number of People:</strong><br>
                <%= f.number_field :num_people, min: 1 %>
              </p>

              <p>
                <%# Primary action is to review details on a confirmation page before final submission %>
                <%= button_tag "Review details", type: 'submit', formaction: confirm_reservations_path, formmethod: 'post', class: 'btn btn-primary' %>
              </p>
            <% end %>
          </div>
          <div class="card-footer text-center">
            <%# Regular users go to the site root; admins go to the admin dashboard %>
            <% if defined?(current_user) && current_user.respond_to?(:admin?) && current_user.admin? %>
              <%= link_to "Back", admin_dashboard_path, class: 'btn btn-primary' %>
            <% else %>
              <%= link_to "Back", root_path, class: 'btn btn-primary' %>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

