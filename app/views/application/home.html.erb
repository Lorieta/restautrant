<div class="home">
  <% if logged_in? %>
    <h1>Welcome back, <%= current_user.name %>!</h1>
    <div class="mt-3">
      <h2>Timeslots - <%= @month.strftime('%B %Y') if defined?(@month) %></h2>

      <div class="mb-2">
        <%= link_to "Previous", root_path(start_date: (@month - 1.month).to_date), class: 'btn btn-secondary' %>
        <%= link_to "Next", root_path(start_date: (@month + 1.month).to_date), class: 'btn btn-secondary' %>
      </div>

      <%# Render a month calendar using simple_calendar (pass the timeslots collection and a start_date) %>
      <%= month_calendar(start_date: @month) do |date| %>
        <div class="calendar-day" style="padding:6px;">
          <strong><%= date.day %></strong>

          <% slots = @timeslots_by_date[date] || @timeslots_by_date[date.to_date] || [] %>
          <% slots.each do |ts| %>
            <div style="margin-top:4px;">
              <small><%= ts.start_time.strftime('%H:%M') %> - <%= ts.end_time&.strftime('%H:%M') %></small>
              <%# Show badge if there are reservations; highlight if current_user has a reservation for this slot %>
              <% reservation = ts.reservations.find { |r| r.user_id == current_user.id } %>
              <% if reservation %>
                <%= reservation_status_badge(reservation) %>
              <% elsif ts.reservations.any? %>
                <span class="badge bg-danger ms-2"><%= ts.reservations.count %></span>
              <% else %>
                <%= link_to 'Book', new_reservation_path(timeslot_id: ts.id), class: 'btn btn-sm btn-primary ms-2' %>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  <% else %>
    <h1>Welcome to Restaurant Reservation</h1>
    <p class="mb-3">Sign in below or <%= link_to 'Sign up', signup_path %> to start making reservations.</p>

    <%= render 'sessions/form' %>
  <% end %>
</div>
